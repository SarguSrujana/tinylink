import {query} from '@/lib/db';function valid(c){return /^[A-Za-z0-9]{6,8}$/.test(c);}function gen(){const s='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let o='';for(let i=0;i<6;i++)o+=s[Math.floor(Math.random()*s.length)];return o;}export async function GET(){return Response.json((await query("SELECT * FROM links ORDER BY created_at DESC")).rows);}export async function POST(req){const{url,code}=await req.json();try{new URL(url);}catch{return Response.json({error:'invalid URL'},{status:400});}let c=code||gen();if(code && !valid(c))return Response.json({error:'invalid code'},{status:400});if((await query("SELECT 1 FROM links WHERE code=$1",[c])).rowCount)return Response.json({error:'exists'},{status:409});await query("INSERT INTO links(code,url)VALUES($1,$2)",[c,url]);return Response.json({code:c},{status:201});}